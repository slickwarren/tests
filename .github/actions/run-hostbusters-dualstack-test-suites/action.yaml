---
name: Run Dualstack Test Suite
description: "Runs a specific test suite based on input"

inputs:
  suite:
    description: "The test suite to run"
    required: true
  reporting:
    description: "Enable reporting"
    required: false
    default: "false"

runs:
  using: composite
  steps:
    - name: Run Selected Test Suite
      id: run-tests
      shell: bash
      continue-on-error: true
      run: |
        set +e

        case "${{ inputs.suite }}" in
          rancher-server-one)
            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/certificates/rke2/dualstack \
              --junitfile results.xml \
              --jsonfile results_rke2_cert.json \
              -- -timeout=5h -tags=recurring -v

            rke2_cert_exit=$?
            echo "rke2_cert_exit=$rke2_cert_exit" >> "$GITHUB_ENV"
            cp results_rke2_cert.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/certificates/k3s/dualstack \
              --junitfile results.xml \
              --jsonfile results_k3s_cert.json \
              -- -timeout=5h -tags=recurring -v

            k3s_cert_exit=$?
            echo "k3s_cert_exit=$k3s_cert_exit" >> "$GITHUB_ENV"
            cp results_k3s_cert.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/deleting/rke2/dualstack \
              --junitfile results.xml \
              --jsonfile results_rke2_delete.json \
              -- -timeout=5h -tags=recurring -v

            rke2_delete_exit=$?
            echo "rke2_delete_exit=$rke2_delete_exit" >> "$GITHUB_ENV"
            cp results_rke2_delete.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/deleting/k3s/dualstack \
              --junitfile results.xml \
              --jsonfile results_k3s_delete.json \
              -- -timeout=5h -tags=recurring -v

            k3s_delete_exit=$?
            echo "k3s_delete_exit=$k3s_delete_exit" >> "$GITHUB_ENV"
            cp results_k3s_delete.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/nodescaling/rke2/dualstack \
              --junitfile results.xml \
              --jsonfile results_rke2_node_scale.json \
              -- -timeout=5h -tags=recurring -v

            rke2_node_scale_exit=$?
            echo "rke2_node_scale_exit=$rke2_node_scale_exit" >> "$GITHUB_ENV"
            cp results_rke2_node_scale.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/nodescaling/k3s/dualstack \
              --junitfile results.xml \
              --jsonfile results_k3s_node_scale.json \
              -- -timeout=5h -tags=recurring -v

            k3s_node_scale_exit=$?
            echo "k3s_node_scale_exit=$k3s_node_scale_exit" >> "$GITHUB_ENV"
            cp results_k3s_node_scale.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi
            ;;
          
          rancher-server-two)
            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/provisioning/dualstack \
              --junitfile results.xml \
              --jsonfile results_prov.json \
              -- -timeout=5h -tags=recurring -v

            prov_exit=$?
            echo "prov_exit=$prov_exit" >> "$GITHUB_ENV"
            cp results_prov.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/snapshot/rke2/dualstack \
              --junitfile results.xml \
              --jsonfile results_rke2_snapshot.json \
              -- -timeout=5h -tags=recurring -v

            rke2_snapshot_exit=$?
            echo "rke2_snapshot_exit=$rke2_snapshot_exit" >> "$GITHUB_ENV"
            cp results_rke2_snapshot.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/snapshot/k3s/dualstack \
              --junitfile results.xml \
              --jsonfile results_k3s_snapshot.json \
              -- -timeout=5h -tags=recurring -v

            k3s_snapshot_exit=$?
            echo "k3s_snapshot_exit=$k3s_snapshot_exit" >> "$GITHUB_ENV"
            cp results_k3s_snapshot.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/upgrade/rke2/dualstack \
              --junitfile results.xml \
              --jsonfile results_upgrade_rke2.json \
              -- -timeout=5h -tags=recurring -v

            upgrade_rke2_exit=$?
            echo "upgrade_rke2_exit=$upgrade_rke2_exit" >> "$GITHUB_ENV"
            cp results_upgrade_rke2.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi

            gotestsum --format standard-verbose \
              --packages=github.com/rancher/tests/validation/upgrade/k3s/dualstack \
              --junitfile results.xml \
              --jsonfile results_upgrade_k3s.json \
              -- -timeout=5h -tags=recurring -v

            upgrade_k3s_exit=$?
            echo "upgrade_k3s_exit=$upgrade_k3s_exit" >> "$GITHUB_ENV"
            cp results_upgrade_k3s.json results.json

            if [[ "${{ inputs.reporting }}" == "true" ]]; then
              ./validation/pipeline/scripts/build_qase_reporter_v2.sh;
              ./validation/reporter
            fi
            ;;
        esac

    - name: Show failed tests
      shell: bash
      run: |
        declare -A suites=(
          [k3s_cert_exit]="K3s Cert Rotation:results_k3s_cert.json"
          [rke2_cert_exit]="RKE2 Cert Rotation:results_rke2_cert.json"
          [rke2_delete_exit]="Delete RKE2 Cluster:results_rke2_delete.json"
          [k3s_delete_exit]="Delete K3S Cluster:results_k3s_delete.json"
          [rke2_node_scale_exit]="RKE2 Node Scaling:results_rke2_node_scale.json"
          [k3s_node_scale_exit]="K3S Node Scaling:results_k3s_node_scale.json"
          [prov_exit]="Provisioning:results_prov.json"
          [rke2_snapshot_exit]="RKE2 Snapshot Restore:results_rke2_snapshot.json"
          [k3s_snapshot_exit]="K3S Snapshot Restore:results_k3s_snapshot.json"
          [upgrade_rke2_exit]="Kubernetes Upgrade RKE2:results_upgrade_rke2.json"
          [upgrade_k3s_exit]="Kubernetes Upgrade K3S:results_upgrade_k3s.json"
        )

        failed=0

        for exit_code in "${!suites[@]}"; do
          IFS=: read suite_name results_file <<< "${suites[$exit_code]}"
          exit_val="${!exit_code}"

          if [ "$exit_val" != "" ] && [ "$exit_val" -ne 0 ]; then
            echo "Failed $suite_name tests:"
            jq -r 'select(.Action=="fail" and .Test != null) | "- " + .Test' "$results_file"
            failed=1
          fi
        done

        if [ "$failed" -eq 1 ]; then
          exit 1
        fi
